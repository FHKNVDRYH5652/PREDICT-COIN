<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Payment — Coin Predictions</title>
<style>
  :root{--muted:#9fb0d6;--accent1:#00d2a8;--accent2:#00a6ff}
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial}
  body{margin:0;padding:24px;background:url('anime2.png') center/cover fixed;color:#eaf6ff}
  .wrap{max-width:980px;margin:0 auto}
  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .card{background:rgba(2,8,18,0.6);padding:18px;border-radius:12px}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
  input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .qr{width:100%;height:260px;border-radius:10px;background:linear-gradient(135deg,#071827,#092536);display:flex;align-items:center;justify-content:center}
  .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));padding:10px 12px;border-radius:8px;border:none;color:#001;font-weight:700;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} .qr{height:160px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="font-weight:800">Payment</div>
      <div class="small">Wallet: <strong id="walletTop">0</strong></div>
    </div>

    <div class="card grid">
      <div>
        <h2 style="margin:0 0 8px 0">Make Payment</h2>
        <div class="small">Selected plan is loaded from Plans page. Pay via QR / UPI then submit UTR (12 digits).</div>

        <div style="margin-top:12px">
          <label class="small">Coins to buy</label>
          <input id="payCoins" readonly>
          <label class="small" style="margin-top:8px">Amount (₹)</label>
          <input id="payAmount" readonly>
          <label class="small" style="margin-top:8px">Enter 12-digit UTR</label>
          <input id="payUTR" maxlength="12" placeholder="123456789012">
          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="submitBtn" class="btn">Submit for Approval</button>
            <button id="cancelBtn" class="btn" style="background:transparent;color:#9fb0d6;border:1px solid rgba(255,255,255,0.04)">Cancel</button>
          </div>
          <div id="msg" class="small" style="margin-top:10px"></div>
        </div>
      </div>

      <div>
        <div class="card" style="padding:14px">
          <div class="qr"><div style="text-align:center"><div style="font-weight:700">QR</div><div class="small">Put Screenshot_20250915-104012.Gallery.png file in same folder</div></div></div>

          <div style="margin-top:12px">
            <div class="small">Customer Service</div>
            <div style="margin-top:8px">
              <button class="btn" onclick="window.open('https://t.me/Nskskssiwi','_blank')">Contact on Telegram</button>
            </div>
            <div style="margin-top:10px" class="small">After admin approves payment, you'll be able to use prediction page.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBs7eQyMrcN8kJWMHl2ac2UZHlYQ6DypD8",
  authDomain: "terminal-xxrr.firebaseapp.com",
  databaseURL: "https://terminal-xxrr-default-rtdb.firebaseio.com",
  projectId: "terminal-xxrr",
  storageBucket: "terminal-xxrr.appspot.com",
  messagingSenderId: "722753278120",
  appId: "1:722753278120:web:bfa37aab39635a4e57f29d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* load pendingPlan from localStorage */
const pending = parseInt(localStorage.getItem('pendingPlan') || '100', 10);
document.getElementById('payCoins').value = pending;
document.getElementById('payAmount').value = (pending * 0.5).toFixed(2);
document.getElementById('walletTop').innerText = localStorage.getItem('wallet_coins') || '0';

onAuthStateChanged(auth, user=>{
  if(user){
    // show user's wallet from firestore when available (optional)
    // but we keep it simple in UI
  }
});

/* submit pending to Firestore (requires logged-in user) */
document.getElementById('submitBtn').addEventListener('click', async ()=>{
  const utr = (document.getElementById('payUTR').value||'').trim();
  if(!/^[0-9]{12}$/.test(utr)){ document.getElementById('msg').innerText = 'Enter valid 12-digit UTR'; return; }
  try{
    // if user logged in, attach userId; else store guest with uid=null
    // Better require login: we'll check auth
    let user = auth.currentUser;
    if(!user){
      // redirect to index/login
      if(confirm('You must be logged in to submit payment. Go to home to login?')) window.location.href='index.html';
      return;
    }
    // create pending doc in 'pending' collection
    await addDoc(collection(db, 'pending'), {
      utr,
      coins: pending,
      amount: (pending * 0.5),
      userId: user.uid,
      userEmail: user.email||null,
      status: 'pending',
      ts: serverTimestamp()
    });
    document.getElementById('msg').innerText = 'Submitted for admin approval. Please wait.';
    // clear local pendingPlan
    localStorage.removeItem('pendingPlan');
    // basic polling redirect when approved: admin will create approved doc with id 'approved_'+utr - but we rely on admin updating pending.status.
    const checkApproved = setInterval(async ()=>{
      const docId = null; // we cannot easily know docId here; better admin will move to approved collection or update pending doc.
      // Simpler: redirect user to prediction page and rely on Firestore wallet sync (admin will credit)
      // We'll just redirect after submit so user can wait in prediction page for wallet to update.
      clearInterval(checkApproved);
      window.location.href = 'prediction.html';
    }, 1200);
  }catch(e){
    document.getElementById('msg').innerText = e.message;
  }
});

document.getElementById('cancelBtn').addEventListener('click', ()=> window.location.href='index.html');
</script>
</body>
</html>
