<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Coin Predictions</title>
<style>
  :root{--muted:#9fb0d6;--accent1:#00d2a8;--accent2:#00a6ff}
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial}
  body{margin:0;padding:24px;background:linear-gradient(180deg,#041020,#071427);color:#eaf6ff}
  .wrap{max-width:1100px;margin:0 auto}
  .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px}
  input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;margin-top:8px}
  .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));padding:10px 12px;border-radius:8px;border:none;color:#001;font-weight:700;cursor:pointer}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--muted)}
  .history{max-height:420px;overflow:auto;padding:8px;border-radius:8px;background:rgba(0,0,0,0.25)}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:800">Admin Panel</div>
      <div class="small">Create admin user in Firebase Auth & add his uid/email to <code>admins</code> collection.</div>
    </div>

    <!-- Login -->
    <div id="loginCard" class="card">
      <h3 style="margin:0">Admin Login</h3>
      <div class="small" style="margin-top:8px">Login with Firebase email/password account that is also in <code>admins</code> collection.</div>
      <input id="adminEmail" placeholder="Email">
      <input id="adminPass" placeholder="Password" type="password">
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="loginBtn" class="btn">Login</button>
        <button id="backBtn" class="ghost" onclick="window.location.href='index.html'">Back</button>
      </div>
      <div id="loginMsg" class="small" style="margin-top:8px"></div>
    </div>

    <!-- Dashboard -->
    <div id="dash" style="display:none;margin-top:12px">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h3 style="margin:0">Pending Payments</h3><div class="small">Approve to credit user's wallet</div></div>
          <div><button id="logoutBtn" class="ghost">Logout</button></div>
        </div>

        <div id="pendingList" class="history" style="margin-top:12px"></div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3 style="margin:0">Approved / Rejected</h3>
        <div class="small" style="margin-top:8px">Recent approved & rejected items</div>
        <div style="display:flex;gap:12px;margin-top:8px">
          <div style="flex:1"><div class="small">Approved</div><div id="approvedList" class="history"></div></div>
          <div style="flex:1"><div class="small">Rejected</div><div id="rejectedList" class="history"></div></div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3 style="margin:0">Wallet (demo)</h3>
        <div class="small">Set demo user's wallet (single-user demo)</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="setWalletInput" placeholder="enter coins (e.g. 500)">
          <button id="setWalletBtn" class="btn">Set Wallet</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBs7eQyMrcN8kJWMHl2ac2UZHlYQ6DypD8",
  authDomain: "terminal-xxrr.firebaseapp.com",
  databaseURL: "https://terminal-xxrr-default-rtdb.firebaseio.com",
  projectId: "terminal-xxrr",
  storageBucket: "terminal-xxrr.appspot.com",
  messagingSenderId: "722753278120",
  appId: "1:722753278120:web:bfa37aab39635a4e57f29d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginCard = document.getElementById('loginCard');
const dash = document.getElementById('dash');
const loginMsg = document.getElementById('loginMsg');

document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPass').value;
  if(!email || !pass){ loginMsg.innerText = 'Enter credentials'; return; }
  try{
    const cred = await signInWithEmailAndPassword(auth, email, pass);
    // check admins collection for either uid or email
    const uid = cred.user.uid;
    const adminByUid = await getDoc(doc(db, 'admins', uid));
    if(adminByUid.exists()){
      showDashboard();
    } else {
      // check any admin doc with field email == email
      // naive scan (small dataset)
      const q = query(collection(db, 'admins'));
      let found = false;
      const snap = await getDocs(q);
      snap.forEach(d=>{
        const data = d.data();
        if(data.email && data.email.toLowerCase() === email.toLowerCase()) found = true;
      });
      if(found) showDashboard();
      else { loginMsg.innerText = 'This account is not an admin (add to admins collection).'; await signOut(auth); }
    }
  }catch(e){
    loginMsg.innerText = e.message;
  }
});

function showDashboard(){
  loginCard.style.display = 'none';
  dash.style.display = 'block';
  subscribePending();
  renderApprovedRejected();
}

document.getElementById('logoutBtn').addEventListener('click', async ()=>{ await signOut(auth); loginCard.style.display='block'; dash.style.display='none'; });

/* subscribe to pending collection realtime */
let unsubscribePending = null;
function subscribePending(){
  const q = query(collection(db, 'pending'), orderBy('ts','desc'));
  unsubscribePending = onSnapshot(q, snap=>{
    const node = document.getElementById('pendingList');
    node.innerHTML = '';
    if(snap.empty) { node.innerHTML = '<div class="small">No pending payments</div>'; return; }
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const id = docSnap.id;
      const row = document.createElement('div');
      row.style.padding='8px'; row.style.borderBottom='1px solid rgba(255,255,255,0.04)';
      row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><b>${d.coins} coins</b> — ₹${(d.amount||0).toFixed(2)}<div class="small">UTR: ${d.utr || '—'} • ${d.userEmail || '—'}</div></div>
        <div><button class="btn" data-id="${id}" style="margin-right:6px">Approve</button><button class="ghost" data-id="${id}">Reject</button></div>
      </div>`;
      node.appendChild(row);
    });
    // attach handlers
    Array.from(node.querySelectorAll('.btn')).forEach(b=> b.onclick = ()=> approve(b.dataset.id));
    Array.from(node.querySelectorAll('.ghost')).forEach(b=> b.onclick = ()=> rejectPending(b.dataset.id));
  });
}

/* approve: update pending.status and credit user wallet (users/{uid}) */
async function approve(docId){
  try{
    const pRef = doc(db, 'pending', docId);
    const pSnap = await getDoc(pRef);
    if(!pSnap.exists()){ alert('Not found'); return; }
    const data = pSnap.data();
    // update user's wallet (get user doc)
    const userRef = doc(db, 'users', data.userId);
    const userSnap = await getDoc(userRef);
    const cur = userSnap.exists() ? (userSnap.data().wallet || 0) : 0;
    await updateDoc(userRef, { wallet: cur + Number(data.coins) });
    // mark pending approved
    await updateDoc(pRef, { status: 'approved', approvedAt: new Date() });
    // also add to approved collection (log)
    await addDoc(collection(db, 'approved'), { ...data, approvedAt: new Date(), approvedBy: auth.currentUser.uid });
    alert('Approved and wallet credited');
    renderApprovedRejected();
  }catch(e){
    alert(e.message || 'Approve failed');
  }
}

async function rejectPending(docId){
  try{
    const pRef = doc(db, 'pending', docId);
    const pSnap = await getDoc(pRef);
    if(!pSnap.exists()){ alert('Not found'); return; }
    const data = pSnap.data();
    await updateDoc(pRef, { status: 'rejected', rejectedAt: new Date() });
    await addDoc(collection(db, 'rejected'), { ...data, rejectedAt: new Date(), rejectedBy: auth.currentUser.uid });
    alert('Rejected');
    renderApprovedRejected();
  }catch(e){
    alert(e.message || 'Reject failed');
  }
}

/* approved/rejected lists */
import { getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
async function renderApprovedRejected(){
  const aNode = document.getElementById('approvedList');
  const rNode = document.getElementById('rejectedList');
  aNode.innerHTML = ''; rNode.innerHTML = '';
  const aSnap = await getDocs(query(collection(db,'approved'), orderBy('ts','desc')));
  aSnap.forEach(d=>{
    const data = d.data();
    const div = document.createElement('div');
    div.style.padding='6px'; div.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    div.innerHTML = `<b>${data.coins} coins</b> • UTR:${data.utr || '-'} • ${new Date(data.approvedAt || data.ts || Date.now()).toLocaleString()}`;
    aNode.appendChild(div);
  });
  const rSnap = await getDocs(query(collection(db,'rejected'), orderBy('ts','desc')));
  rSnap.forEach(d=>{
    const data = d.data();
    const div = document.createElement('div');
    div.style.padding='6px'; div.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    div.innerHTML = `<b>${data.coins} coins</b> • UTR:${data.utr || '-'} • ${new Date(data.rejectedAt || data.ts || Date.now()).toLocaleString()}`;
    rNode.appendChild(div);
  });
}

/* set wallet (demo utility) */
document.getElementById('setWalletBtn').addEventListener('click', async ()=>{
  const v = parseInt(document.getElementById('setWalletInput').value||'0',10);
  if(isNaN(v)){ alert('Enter number'); return; }
  // demo: set wallet for current signed in admin? Not meaningful — better to set for a test user with uid known.
  // For simplicity: set localStorage fallback
  localStorage.setItem('wallet_coins', String(v));
  alert('Set demo wallet (localStorage) to ' + v);
});

/* helper imports used above */
import { doc as docRef } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

</script>
</body>
</html>
