<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Prediction — Coin Predictions</title>
<style>
  :root{--muted:#9fb0d6;--accent1:#00d2a8;--accent2:#00a6ff}
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial}
  body{margin:0;padding:20px;background:url('anime3.png') center/cover fixed;color:#eaf6ff}
  .wrap{max-width:980px;margin:0 auto}
  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .card{background:rgba(2,8,18,0.6);padding:18px;border-radius:12px}
  .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));padding:10px 14px;border-radius:8px;border:none;color:#001;cursor:pointer;font-weight:800}
  .small{font-size:13px;color:var(--muted)}
  .period{font-weight:800;font-size:18px}
  .history{max-height:240px;overflow:auto;border-radius:8px;padding:8px;background:rgba(0,0,0,0.25);margin-top:12px}
</style>
</head>
<body>
  <audio src="music.m4a" autoplay loop></audio>
  <div class="wrap">
    <div class="top">
      <div style="font-weight:900">Coin Predictions — Play</div>
      <div class="small">Wallet: <strong id="wallet">0</strong> coins</div>
    </div>

    <div class="card">
      <div><span class="small">Live period:</span> <span class="period" id="livePeriod">—</span></div>
      <div style="margin-top:8px" class="small" id="countdown">Next period in: --s</div>

      <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
        <button id="genBtn" class="btn">Generate Prediction (10 coins)</button>
        <button id="refreshBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">Refresh Wallet</button>
      </div>

      <div id="resultArea" style="margin-top:14px;display:none">
        <div class="card" style="padding:12px">
          <div><b>Period:</b> <span id="predPeriod">—</span></div>
          <div style="margin-top:8px"><b>Signal:</b> <span id="predSignal">—</span></div>
          <div style="margin-top:8px"><b>Numbers:</b> <span id="predNums">—</span></div>
        </div>
      </div>

      <div style="margin-top:12px" class="small">History (latest first):</div>
      <div id="hist" class="history"></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBs7eQyMrcN8kJWMHl2ac2UZHlYQ6DypD8",
  authDomain: "terminal-xxrr.firebaseapp.com",
  databaseURL: "https://terminal-xxrr-default-rtdb.firebaseio.com",
  projectId: "terminal-xxrr",
  storageBucket: "terminal-xxrr.appspot.com",
  messagingSenderId: "722753278120",
  appId: "1:722753278120:web:bfa37aab39635a4e57f29d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const BASE_PERIOD = 20250914100011164n;
const BASE_DATE = new Date('2025-09-14T12:53:00+05:30'); // user's base

function currentPeriod(){
  const now = new Date();
  const diffMin = Math.floor((now - BASE_DATE) / 60000);
  return String(BASE_PERIOD + BigInt(diffMin));
}
function secondsToNextMinute(){
  const now = Date.now();
  return Math.max(0, Math.round((Math.ceil(now/60000)*60000 - now)/1000));
}
function updatePeriodUI(){
  document.getElementById('livePeriod').innerText = currentPeriod();
  document.getElementById('countdown').innerText = 'Next period in: ' + secondsToNextMinute() + 's';
}
setInterval(updatePeriodUI, 1000);
updatePeriodUI();

/* wallet real-time from Firestore users/{uid}.wallet */
function showWallet(n){ document.getElementById('wallet').innerText = n; }
function loadHistory(){
  const arr = JSON.parse(localStorage.getItem('__preds__')||'[]');
  const el = document.getElementById('hist');
  el.innerHTML = '';
  if(arr.length===0){ el.innerHTML = '<div class="small">No predictions yet</div>'; return; }
  arr.slice(0,200).forEach(p=>{
    const d = document.createElement('div');
    d.style.padding='8px'; d.style.borderBottom='1px solid rgba(255,255,255,0.04)';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><b>${p.period}</b><div class="small">${p.signal} • ${p.nums}</div></div><div class="small">${new Date(p.ts).toLocaleTimeString()}</div></div>`;
    el.appendChild(d);
  });
}

/* Auth and wallet listener */
let userUid = null;
onAuthStateChanged(auth, user=>{
  if(user){
    userUid = user.uid;
    const uref = doc(db, 'users', userUid);
    onSnapshot(uref, snap=>{
      const data = snap.exists() ? snap.data() : null;
      showWallet(data ? (data.wallet||0) : 0);
    });
  } else {
    // fallback: show localStorage
    userUid = null;
    showWallet(parseInt(localStorage.getItem('wallet_coins')||'0',10));
  }
});
/* Generate prediction: requires logged-in user; uses transaction to deduct 10 coins */
document.getElementById('genBtn').addEventListener('click', async ()=>{
  const PRED_COST = 10;
  if(!userUid){
    if(confirm('You must be logged in to generate prediction. Go to home to login?')) window.location.href='index.html';
    return;
  }
  const userRef = doc(db, 'users', userUid);
  try{
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(userRef);
      if(!snap.exists()) throw new Error('User doc not found');
      const cur = snap.data().wallet || 0;
      if(cur < PRED_COST) throw new Error('Not enough coins');
      tx.update(userRef, { wallet: cur - PRED_COST });
    });
    // now generate prediction locally and store in local history
    const signal = Math.random() < 0.5 ? 'SMALL' : 'BIG';
    let a,b;
    if(signal === 'SMALL'){ a = Math.floor(Math.random()*5); b = Math.floor(Math.random()*5); }
    else { a = 5 + Math.floor(Math.random()*5); b = 5 + Math.floor(Math.random()*5); }
    const period = currentPeriod();
    const nums = `${a} / ${b}`;
    document.getElementById('resultArea').style.display = 'block';
    document.getElementById('predPeriod').innerText = period;
    document.getElementById('predSignal').innerText = signal;
    document.getElementById('predNums').innerText = nums;
    const arr = JSON.parse(localStorage.getItem('__preds__')||'[]');
    arr.unshift({ period, signal, nums, ts: Date.now() });
    localStorage.setItem('__preds__', JSON.stringify(arr.slice(0,200)));
    loadHistory();
  }catch(err){
    alert(err.message || 'Transaction failed');
  }
});
document.getElementById('refreshBtn').addEventListener('click', ()=> loadHistory());

loadHistory();
</script>
</body>
</html>
